<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Calendario</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">

    <!-- CSS de FullCalendar -->
    <link href="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.css" rel="stylesheet">

    <!-- JS de FullCalendar -->
    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@5.10.1/main.min.js"></script>
</head>
<body>

    <h1 class="page-title">Calendario de {{ current_user.nombre }} {{ current_user.apellidos }}</h1>

    <!-- üîπ Contenedor de botones centrado -->
    <div class="button-container">
        <button onclick="window.location.href='/add-vacation'">‚úàÔ∏è Gesti√≥n de Vacaciones</button>
        <button onclick="window.location.href='/calendar'">üìÖ Ver Calendario</button>
        <button onclick="window.location.href='/logout'">‚ùå Cerrar Sesi√≥n</button>
        <button onclick="window.location.href='/dashboard'" class="back-button">üîô Volver al Men√∫ Principal</button>
        {% if current_user.is_authenticated and current_user.puesto == "Administrador/a" %}
        <button onclick="window.location.href='/admin/users'">üë©‚Äçüîß Administrar Usuarios</button>
        <button onclick="window.location.href='/admin/asignar-estados'">‚öôÔ∏è Administrar Estados</button>
        <button onclick="window.location.href='/dashboard-metrics'">üìà Ver M√©tricas</button>
        {% endif %}
    </div>

    <!-- üîπ Filtros + Leyenda -->
    <div class="calendar-controls">
        <div class="filters">
            <span>Estado:</span>
            <div id="stateFilterGroup" class="state-group" role="group" aria-label="Filtrar por estados">
                <label class="state-chip"><input type="checkbox" value="todos" checked>Todos</label>
                <label class="state-chip"><input type="checkbox" value="PIAS">PIAS</label>
                <label class="state-chip"><input type="checkbox" value="Ausente">Vacaciones</label>
                <label class="state-chip"><input type="checkbox" value="CADE 30">CADE 30</label>
                <label class="state-chip"><input type="checkbox" value="CADE 50">CADE 50</label>
                <label class="state-chip"><input type="checkbox" value="CADE Tardes">CADE Tardes</label>
                <label class="state-chip"><input type="checkbox" value="Guardia CADE">Guardia CADE</label>
                <label class="state-chip"><input type="checkbox" value="Refuerzo Cade">Refuerzo Cade</label>
                <label class="state-chip"><input type="checkbox" value="Mail">Mail</label>
                <label class="state-chip"><input type="checkbox" value="Baja">Baja</label>
            </div>

            <label for="roleFilter">Rol:</label>
            <select id="roleFilter">
                <option value="todos">Todos</option>
                <option value="TS">TS</option>
                <option value="ADM">ADM</option>
                <option value="Administrador/a">Administrador/a</option>
            </select>

            <label for="personFilter">Persona:</label>
            <select id="personFilter">
                <option value="todos">Todos</option>
                {% if usuarios %}
                    {% for usuario in usuarios %}
                        <option value="{{ usuario.nombre }} {{ usuario.apellidos }}">
                            {{ usuario.nombre }} {{ usuario.apellidos }}
                        </option>
                    {% endfor %}
                {% else %}
                    <option value="" disabled>No hay usuarios disponibles</option>
                {% endif %}
            </select>

            <label for="searchInput">Buscar:</label>
            <input id="searchInput" type="search" placeholder="Nombre o apellido" />
        </div>

        <div class="legend">
            <span class="legend-title">Leyenda</span>
            <span class="dot dot-ts" title="TS"></span> TS
            <span class="dot dot-adm" title="ADM"></span> ADM
            <span class="dot dot-admin" title="Admin"></span> Admin
            <span class="pill pill-ausente">Vacaciones</span>
            <span class="pill pill-baja">Baja</span>
            <span class="pill pill-cade30">CADE 30</span>
            <span class="pill pill-cade50">CADE 50</span>
            <span class="pill pill-cadetardes">CADE Tardes</span>
            <span class="pill pill-guardia">Guardia CADE</span>
            <span class="pill pill-refuerzo">Refuerzo Cade</span>
            <span class="pill pill-mail">Mail</span>
        </div>
    </div>

    <!-- üîπ Calendario -->
    <div id="calendar"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            try {
                // Parse usuarios safely
                const usuarios = JSON.parse('{{ usuarios|tojson|safe }}');
                console.log("Usuarios disponibles:", usuarios);
                
                var calendarEl = document.getElementById('calendar');
                var allEvents = [];
                const selectedStates = new Set(); // vac√≠o = Todos
                let currentPersonFilter = 'todos';
                let currentSearch = '';
                let currentRoleFilter = 'todos';

                function cleanTitle(title) {
                    // Remove extra spaces and normalize text
                    return title.replace(/\s+/g, ' ').trim();
                }

                function normalizeString(str) {
                    return str
                        .normalize('NFD')
                        .replace(/[\u0300-\u036f]/g, '')
                        .toLowerCase()
                        .replace(/\s+/g, ' ')
                        .trim();
                }

                var calendar = new FullCalendar.Calendar(calendarEl, {
                    initialView: 'dayGridMonth',
                    firstDay: 1, 
                    locale: 'es',
                    selectable: true,
                    eventOrder: "title",  // Mantener el orden enviado por el backend
                    headerToolbar: {
                      left: 'prev,today,next',
                      center: 'title',
                      right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    footerToolbar: {
                      left: 'prev,today,next',
                      center: '',
                      right: 'dayGridMonth,timeGridWeek,timeGridDay'
                    },
                    events: function(fetchInfo, successCallback, failureCallback) {
                        fetch('/api/events')
                            .then(response => response.json())
                            .then(data => {
                                allEvents = data.eventos;
                                console.log("Filtros actuales:", {
                                    estados: Array.from(selectedStates),
                                    persona: currentPersonFilter,
                                    rol: currentRoleFilter,
                                    search: currentSearch
                                });

                                const filtered = allEvents.filter(event => {
                                    const eventTitle = cleanTitle(event.title || '');
                                    const ext = event.extendedProps || {};
                                    const estado = (ext.estado || (eventTitle.match(/\(([^)]+)\)/)?.[1] || 'PIAS'));
                                    const nombre = (ext.nombre || eventTitle.split('(')[0].replace(/^(TS|ADM|Administrador\/a)\s*-\s*/, '').trim());
                                    
                                    // Filtro por estados m√∫ltiples: vac√≠o = todos
                                    let passesStateFilter = true;
                                    if (selectedStates.size > 0) {
                                        passesStateFilter = selectedStates.has(estado);
                                    }
                                    
                                    // Filtro por persona
                                    let passesPersonFilter = true;
                                    if (currentPersonFilter !== 'todos') {
                                        const normalizedFullName = normalizeString(nombre);
                                        const normalizedFilter = normalizeString(currentPersonFilter);
                                        passesPersonFilter = normalizedFullName === normalizedFilter;
                                        
                                        if (passesPersonFilter) {
                                            console.log(`Evento coincidente: "${eventTitle}" -> "${nombre}"`);
                                        }
                                    }

                                    // Filtro por rol
                                    let passesRole = true;
                                    if (currentRoleFilter !== 'todos') {
                                        const puesto = (ext.puesto || '').trim();
                                        passesRole = puesto === currentRoleFilter;
                                    }

                                    // B√∫squeda libre (nombre)
                                    let passesSearch = true;
                                    if (currentSearch) {
                                        passesSearch = normalizeString(nombre).includes(normalizeString(currentSearch));
                                    }

                                    return passesStateFilter && passesPersonFilter && passesRole && passesSearch;
                                });

                                console.log(`Eventos filtrados: ${filtered.length} de ${allEvents.length}`);
                                successCallback(filtered);
                            })
                            .catch(error => {
                                console.error("Error al cargar eventos:", error);
                                failureCallback(error);
                            });
                    },
                    eventContent: function(arg) {
                        // Render compacto: punto por puesto + nombre + chip de estado
                        const title = arg.event.title || '';
                        const ext = arg.event.extendedProps || {};
                        const estado = ext.estado || (title.match(/\(([^)]+)\)/)?.[1]);
                        const nombre = ext.nombre || title.split('(')[0].replace(/^(TS|ADM|Administrador\/a)\s*-\s*/, '').trim();
                        const puesto = (ext.puesto || title.split(' - ')[0] || '').toLowerCase();
                        
                        // Festivo u otros
                        if (/^festivo$/i.test(title)) return { html: `<div class="evt evt-festivo">${title}</div>` };

                        const dotClass = puesto.includes('ts') ? 'dot-ts' : puesto.includes('adm') && !puesto.includes('administrador') ? 'dot-adm' : 'dot-admin';
                        let pill = '';
                        if (estado && estado !== 'PIAS') {
                            const key = (estado || '').toLowerCase();
                            const map = {
                                'ausente': 'pill-ausente',
                                'baja': 'pill-baja',
                                'cade 30': 'pill-cade30',
                                'cade 50': 'pill-cade50',
                                'cade tardes': 'pill-cadetardes',
                                'guardia cade': 'pill-guardia',
                                'refuerzo cade': 'pill-refuerzo',
                                'mail': 'pill-mail'
                            };
                            const cls = map[key] || 'pill-other';
                            pill = `<span class="pill ${cls}">${estado}</span>`;
                        }
                        return { html: `<div class="evt"><span class="dot ${dotClass}"></span><span class="name">${nombre}</span>${pill}</div>` };
                    },
                    eventDidMount: function(info) {
                        // Sin fondos especiales: mantenemos eventos neutros
                    }
                });
        
                calendar.render();

                // Event listeners
                const personFilter = document.getElementById('personFilter');
                const stateFilterGroup = document.getElementById('stateFilterGroup');
                const searchInput = document.getElementById('searchInput');
                const roleFilter = document.getElementById('roleFilter');

                personFilter.addEventListener('change', function() {
                    currentPersonFilter = this.value;
                    console.log(`Aplicando filtro de persona: "${currentPersonFilter}"`);
                    calendar.refetchEvents();
                });

                // Gesti√≥n de selecci√≥n m√∫ltiple de estados
                const allBox = stateFilterGroup.querySelector('input[value="todos"]');
                const stateBoxes = Array.from(stateFilterGroup.querySelectorAll('input[type="checkbox"]:not([value="todos"])'));
                function syncSelectedStates() {
                    selectedStates.clear();
                    stateBoxes.forEach(cb => { if (cb.checked) selectedStates.add(cb.value); });
                    calendar.refetchEvents();
                }
                allBox.addEventListener('change', () => {
                    if (allBox.checked) {
                        stateBoxes.forEach(cb => cb.checked = false);
                    }
                    syncSelectedStates();
                });
                stateBoxes.forEach(cb => cb.addEventListener('change', () => {
                    if (cb.checked) allBox.checked = false;
                    const any = stateBoxes.some(b => b.checked);
                    if (!any) allBox.checked = true; // sin selecci√≥n = todos
                    syncSelectedStates();
                }));

                roleFilter.addEventListener('change', function() {
                    currentRoleFilter = this.value;
                    calendar.refetchEvents();
                });

                searchInput.addEventListener('input', function() {
                    currentSearch = this.value;
                    calendar.refetchEvents();
                });
            } catch (error) {
                console.error("Error al inicializar el calendario:", error);
            }
        });
    </script>

</body>
</html>
