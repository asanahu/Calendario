<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Métricas de Disponibilidad</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    <!-- FullCalendar CSS for compact range selector -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.4/index.global.min.css" crossorigin="anonymous" />
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Calendario compacto (mismo estilo que add-recurring) */
        .calendar-container { margin-bottom: 10px; background: #fff; padding: 12px; border-radius: 10px; box-shadow: 0 4px 16px rgba(0,0,0,0.08); max-width: 360px; }
        .calendar-container .fc { font-size: 12px; }
        .calendar-container .fc .fc-toolbar { margin-bottom: 6px; }
        .calendar-container .fc .fc-toolbar-title { font-size: 1rem; }
        .calendar-container .fc .fc-button { padding: 2px 6px; font-size: 12px; }
        .calendar-container .fc .fc-daygrid-day-number { font-size: 0.8rem; padding: 2px; }
        .calendar-container .fc .fc-daygrid-day-frame { padding: 2px; }
        .calendar-container .fc .fc-daygrid-day-events, .calendar-container .fc .fc-daygrid-day-bottom { display: none; }
        .calendar-instructions { text-align: left; color: #666; font-size: 12px; margin-bottom: 8px; font-style: italic; }
        .date-range-info { margin-top: 8px; padding: 6px 10px; background: #e8f5e8; border-radius: 6px; font-weight: 500; color: #2e7d32; font-size: 13px; border-left: 4px solid #4caf50; }
        .date-range-info.hidden { display: none; }
        .filter-grid { display: grid; grid-template-columns: 1fr auto; gap: 16px; align-items: start; }
        .filter-controls { display: flex; gap: 12px; align-items: end; flex-wrap: wrap; }
        .filter-controls .filter-item { display: flex; flex-direction: column; }
        .table-period-info { margin: 0 0 12px 0; padding: 8px 12px; background: #eef3ff; border-left: 4px solid #5c6bc0; border-radius: 6px; font-size: 13px; color: #32436a; }
    </style>
</head>
<body>
    <div class="metrics-container">
        <div class="metrics-header">
            <h1 class="page-title">Métricas de Disponibilidad</h1>
            <button class="back-button" onclick="window.location.href='/dashboard'">Volver</button>
        </div>

        <div class="card filter-card">
            <form method="get" class="filter-form" id="metricsFilterForm">
                <!-- Hidden inputs for date range -->
                <input type="hidden" id="fecha_inicio" name="fecha_inicio" value="{{ fecha_inicio or '' }}">
                <input type="hidden" id="fecha_fin" name="fecha_fin" value="{{ fecha_fin or '' }}">
                <div class="filter-grid">
                    <div>
                        <div class="calendar-instructions">Selecciona un rango (opcional):</div>
                        <div class="calendar-container">
                            <div id="dateRangeCalendar"></div>
                            <div id="dateRangeInfo" class="date-range-info hidden">
                                <span id="rangeText"></span>
                            </div>
                        </div>
                    </div>
                    <div class="filter-controls">
                        <div class="filter-item">
                            <label for="puesto">Rol/Puesto</label>
                            <select id="puesto" name="puesto">
                                <option value="" {{ '' == (puesto or '') and 'selected' or '' }}>Todos</option>
                                <option value="TS" {{ (puesto or '') == 'TS' and 'selected' or '' }}>TS</option>
                                <option value="ADM" {{ (puesto or '') == 'ADM' and 'selected' or '' }}>ADM</option>
                                <option value="Administrador/a" {{ (puesto or '') in ['Administrador/a','Admin'] and 'selected' or '' }}>Admin</option>
                            </select>
                        </div>
                        <div class="filter-actions">
                            <button type="submit">Filtrar</button>
                            <button type="button" id="exportExcelBtn">Exportar Excel</button>
                        </div>
                    </div>
                </div>
                <!-- Dummy submit for range-calendar to avoid disabling real submit -->
                <button type="button" id="dummySubmit" style="display:none"></button>
            </form>
        </div>

        <div class="kpi-grid">
            <div class="kpi-card">
                <div class="kpi-label">Trabajadores</div>
                <div class="kpi-value">{{ metricas|length }}</div>
            </div>
            <div class="kpi-card">
                <div class="kpi-label">PIAS</div>
                <div class="kpi-value">{{ total_pias|int }}</div>
            </div>
            {% for estado in estados %}
                {% set total_ns = namespace(total=0) %}
                {% for _trabajador, datos in metricas.items() %}
                    {% set total_ns.total = total_ns.total + (datos.get(estado, 0)) %}
                {% endfor %}
                <div class="kpi-card">
                    <div class="kpi-label">{{ estado }}</div>
                    <div class="kpi-value">{{ total_ns.total }}</div>
                </div>
            {% endfor %}
            {% set eventos_ns = namespace(total=0) %}
            {% for _trabajador, datos in metricas.items() %}
                {% for estado in estados %}
                    {% set eventos_ns.total = eventos_ns.total + (datos.get(estado, 0)) %}
                {% endfor %}
            {% endfor %}
            <div class="kpi-card">
                <div class="kpi-label">Eventos (total)</div>
                <div class="kpi-value">{{ eventos_ns.total }}</div>
            </div>
        </div>

        <div class="card">
            {% if fecha_inicio and fecha_fin %}
            <div class="table-period-info">Mostrando datos del <strong>{{ fecha_inicio }}</strong> al <strong>{{ fecha_fin }}</strong> ({{ dias_periodo|int }} dias habiles)</div>
            {% endif %}
            <div class="table-wrap">
                <table class="metrics-table">
                    <thead>
                        <tr>
                            <th>Trabajador</th>
                            <th>PIAS</th>
                            {% for estado in estados %}
                            <th>{{ estado }}</th>
                            {% endfor %}
                        </tr>
                    </thead>
                    <tbody>
                        {% for trabajador, datos in metricas.items() %}
                        <tr>
                            <td class="col-sticky">{{ trabajador }}</td>
                            <td>{{ datos.get('PIAS', 0)|int }}</td>
                            {% for estado in estados %}
                            <td>{{ datos.get(estado, 0) }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>
            <div class="table-hint">Pulsa en un encabezado para ordenar</div>
        </div>

        <div class="section-header">
            <h2>Top 5 por Tipo</h2>
            <p class="section-subtitle">Comparativa rápida por estado</p>
        </div>
        <div class="chart-grid">
        {% for tipo, top5 in top5_por_tipo.items() %}
            <div class="chart-container">
                <h3>{{ tipo }}</h3>
                <canvas id="chart-{{ loop.index }}"></canvas>
            </div>
            <script>
                const ctx{{ loop.index }} = document.getElementById('chart-{{ loop.index }}').getContext('2d');
                new Chart(ctx{{ loop.index }}, {
                    type: 'bar',
                    data: {
                        labels: {{ top5 | map(attribute=0) | list | tojson }},
                        datasets: [{
                            label: '{{ tipo }}',
                            data: {{ top5 | map(attribute=1) | list | tojson }},
                            backgroundColor: 'rgba(54, 162, 235, 0.7)',
                            borderColor: '#1E88E5',
                            borderWidth: 1,
                            borderRadius: 6,
                        }]
                    },
                    options: {
                        responsive: true,
                        plugins: {
                            legend: { display: false }
                        },
                        scales: {
                            x: {
                                ticks: { color: '#333' },
                                grid: { display: false }
                            },
                            y: {
                                beginAtZero: true,
                                ticks: { color: '#333' },
                                grid: { color: 'rgba(0,0,0,0.06)' }
                            }
                        }
                    }
                });
            </script>
        {% endfor %}
        </div>
    </div>

    <script>
        // Exportar Excel manteniendo los filtros actuales
        document.getElementById('exportExcelBtn').addEventListener('click', function() {
            const fi = document.getElementById('fecha_inicio').value;
            const ff = document.getElementById('fecha_fin').value;
            const pu = document.getElementById('puesto').value;
            const params = new URLSearchParams();
            if (fi) params.append('fecha_inicio', fi);
            if (ff) params.append('fecha_fin', ff);
            if (pu) params.append('puesto', pu);
            const url = '/dashboard-metrics/export' + (params.toString() ? ('?' + params.toString()) : '');
            window.location.href = url;
        });

        // Ordenación de columnas con indicador visual
        document.querySelectorAll('.metrics-table th').forEach((header) => {
            header.addEventListener('click', () => {
                const table = header.closest('table');
                const index = Array.from(header.parentElement.children).indexOf(header);
                const rows = Array.from(table.querySelectorAll('tbody tr'));
                const ascending = !header.classList.contains('asc');

                rows.sort((a, b) => {
                    const cellA = a.children[index].innerText.trim();
                    const cellB = b.children[index].innerText.trim();
                    const numA = parseFloat(cellA.replace(',', '.'));
                    const numB = parseFloat(cellB.replace(',', '.'));
                    if (!isNaN(numA) && !isNaN(numB)) {
                        return ascending ? numA - numB : numB - numA;
                    }
                    return ascending ? cellA.localeCompare(cellB) : cellB.localeCompare(cellA);
                });

                header.parentElement.querySelectorAll('th').forEach(h => h.classList.remove('asc', 'desc'));
                header.classList.toggle('asc', ascending);
                header.classList.toggle('desc', !ascending);
                rows.forEach(row => table.querySelector('tbody').appendChild(row));
            });
        });
    </script>

    <!-- FullCalendar + range calendar initializer -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.4/index.global.min.js" crossorigin="anonymous"></script>
    <script src="{{ url_for('static', filename='js/range-calendar.js') }}"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize compact date-range calendar; keep submit always enabled in this page
            initializeDateRangeCalendar({
                calendarId: 'dateRangeCalendar',
                startInputId: 'fecha_inicio',
                endInputId: 'fecha_fin',
                infoContainerId: 'dateRangeInfo',
                infoTextId: 'rangeText',
                submitSelector: '#dummySubmit'
            });
        });
    </script>
</body>
</html>
