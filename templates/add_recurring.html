<!DOCTYPE html>
<html lang="es">

<head>
  <meta charset="UTF-8">
  <title>Asignar Estados Recurrentes</title>
  <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
  <!-- FullCalendar CSS -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.4/index.global.min.css"
    crossorigin="anonymous" />
  <style>
    .hidden {
      display: none;
    }

    .form-container {
      max-width: 1200px;
      margin: 30px auto;
      padding: 20px;
      background: #f9f9f9;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
    }

    .form-group {
      margin-bottom: 15px;
    }

    label {
      display: block;
      margin-bottom: 5px;
      font-weight: bold;
    }

    select,
    input[type="date"] {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    /* Filtros + acciones */
    .filters-bar {
      display: flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
      border: 1px solid #eaeef5;
      padding: 12px;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      margin: 16px 0;
    }

    .filters-bar input[type="search"],
    .filters-bar select {
      padding: 8px 10px;
      border: 1px solid #dcdcdc;
      border-radius: 10px;
      background: #fff;
    }

    #filtroPuesto {
      font-size: 12px;
      padding: 6px 8px;
      width: auto;
      min-width: 120px;
    }

    #searchTrab {
      font-size: 13px;
      padding: 6px 10px;
      min-width: 220px;
    }

    .selection-actions {
      display: flex;
      gap: 8px;
      align-items: center;
      margin-left: auto;
    }

    .selection-actions select {
      padding: 8px 10px;
      border: 1px solid #dcdcdc;
      border-radius: 8px;
    }

    .selection-actions button {
      padding: 8px 12px;
      border-radius: 8px;
      background: #0d6efd;
      color: #fff;
      border: none;
      cursor: pointer;
    }

    .selection-actions button:hover {
      background: #0b5ed7;
    }

    /* Secciones y grilla en 3 columnas */
    .columns {
      display: block;
    }

    .column-box {
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
      padding: 12px;
      margin-bottom: 16px;
    }

    .column-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 8px;
    }

    .column-title {
      font-weight: 700;
      color: #333;
    }

    .rows {
      display: grid;
      grid-template-columns: repeat(3, minmax(200px, 1fr));
      gap: 6px 10px;
    }

    .row {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 8px;
      padding: 6px 8px;
      border: 1px solid #f0f0f0;
      border-radius: 8px;
    }

    .row .name {
      font-size: 13px;
      font-weight: 600;
      color: #222;
    }

    .row select {
      padding: 6px 8px;
      font-size: 12px;
      border-radius: 8px;
    }

    @media (max-width: 1200px) {
      .rows {
        grid-template-columns: repeat(2, minmax(200px, 1fr));
      }
    }

    @media (max-width: 800px) {
      .rows {
        grid-template-columns: 1fr;
      }
    }

    .visually-hidden {
      position: absolute !important;
      height: 1px;
      width: 1px;
      overflow: hidden;
      clip: rect(1px, 1px, 1px, 1px);
      white-space: nowrap;
    }

    .btn {
      background-color: #007BFF;
      color: white;
      padding: 10px 20px;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin-top: 20px;
    }

    .btn:hover {
      background-color: #0056b3;
    }

    .btn:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    /* Estilos para el calendario compacto */
    .calendar-container {
      margin-bottom: 20px;
      background: white;
      padding: 12px;
      border-radius: 10px;
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.08);
      max-width: 360px;
      margin-left: auto;
      margin-right: auto;
    }

    #dateRangeCalendar {
      max-width: 340px;
      margin: 0 auto;
    }

    /* Compactar FullCalendar dentro del contenedor */
    .calendar-container .fc {
      font-size: 12px;
    }

    .calendar-container .fc .fc-toolbar {
      margin-bottom: 6px;
    }

    .calendar-container .fc .fc-toolbar-title {
      font-size: 1rem;
    }

    .calendar-container .fc .fc-button {
      padding: 2px 6px;
      font-size: 12px;
    }

    .calendar-container .fc .fc-daygrid-day-number {
      font-size: 0.8rem;
      padding: 2px;
    }

    .calendar-container .fc .fc-daygrid-day-frame {
      padding: 2px;
    }

    /* Eliminar espacio bajo el n√∫mero del d√≠a (no mostramos eventos aqu√≠) */
    .calendar-container .fc .fc-daygrid-day-events {
      display: none;
      min-height: 0;
    }

    .calendar-container .fc .fc-daygrid-day-bottom {
      display: none;
    }

    .date-range-info {
      margin-top: 10px;
      padding: 8px 12px;
      background: #e8f5e8;
      border-radius: 6px;
      text-align: center;
      font-weight: 500;
      color: #2e7d32;
      font-size: 14px;
      border-left: 4px solid #4caf50;
    }

    .date-range-info.hidden {
      display: none;
    }

    .calendar-instructions {
      text-align: center;
      color: #666;
      font-size: 13px;
      margin-bottom: 10px;
      font-style: italic;
    }

    /* ====== Controles de recurrencia (cada X semanas + d√≠as) ====== */
    .recur-card {
      background: linear-gradient(180deg, #ffffff 0%, #f8fbff 100%);
      border: 1px solid #eaeef5;
      border-radius: 12px;
      box-shadow: 0 6px 20px rgba(0, 0, 0, 0.06);
      padding: 12px;
      margin: 16px 0;
    }

    .recur-row {
      display: flex;
      align-items: center;
      gap: 10px;
      flex-wrap: wrap;
    }

    .recur-label {
      font-weight: 700;
      color: #333;
    }

    .recur-input {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      background: #fff;
      border: 1px solid #dcdcdc;
      border-radius: 10px;
      padding: 6px 10px;
    }

    .recur-input input[type="number"] {
      width: 80px;
      border: none;
      outline: none;
      font-size: 14px;
      text-align: center;
    }

    .recur-suffix {
      color: #556070;
      font-size: 13px;
    }

    .weekday-header {
      margin: 10px 0 6px;
      font-weight: 700;
      color: #333;
    }

    .weekday-group {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .weekday-toggle {
      position: relative;
    }

    .weekday-input {
      position: absolute;
      opacity: 0;
      pointer-events: none;
    }

    .weekday-pill {
      display: inline-block;
      padding: 8px 10px;
      border-radius: 999px;
      background: #fff;
      border: 1px solid #dcdcdc;
      color: #1f2d3d;
      font-size: 13px;
      font-weight: 700;
      letter-spacing: 0.2px;
      box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04);
      cursor: pointer;
      user-select: none;
    }

    .weekday-input:checked+.weekday-pill {
      background: #0d6efd;
      color: #fff;
      border-color: #0b5ed7;
    }

    .weekday-pill:hover {
      background: #f5f8ff;
    }

    .weekday-input:focus+.weekday-pill {
      outline: 3px solid rgba(13, 110, 253, 0.25);
      outline-offset: 2px;
    }
  </style>
</head>

<body>
  <div class="form-container">
    <h1 class="page-title">Asignar Estados Recurrentes</h1>
    <form method="POST">
      <!-- Campos ocultos para enviar las fechas al backend -->
      <input type="hidden" id="fecha_inicio" name="fecha_inicio" required>
      <input type="hidden" id="fecha_fin" name="fecha_fin" required>

      <!-- Calendario compacto para selecci√≥n de rango de fechas -->
      <div class="calendar-container">
        <h3 style="text-align: center; margin-bottom: 10px; color: #333;">üìÖ Seleccionar Fechas</h3>
        <div class="calendar-instructions">
          Haz clic en dos fechas para seleccionar el rango
        </div>
        <div id="dateRangeCalendar"></div>
        <div id="dateRangeInfo" class="date-range-info hidden">
          <span id="rangeText"></span>
        </div>
      </div>
      <div class="recur-card" role="group" aria-label="Configuraci√≥n de recurrencia">
        <div class="recur-row">
          <label for="n_semanas" class="recur-label">Cada</label>
          <div class="recur-input">
            <input type="number" id="n_semanas" name="n_semanas" min="1" value="1" aria-label="Cada N semanas" />
            <span class="recur-suffix">semanas</span>
          </div>
        </div>
        <div class="weekday-header">D√≠as de la semana</div>
        <div class="weekday-group">
          <div class="weekday-toggle">
            <input class="weekday-input" type="checkbox" id="dw-0" name="dias_semana" value="0">
            <label class="weekday-pill" for="dw-0" title="Lunes">Lun</label>
          </div>
          <div class="weekday-toggle">
            <input class="weekday-input" type="checkbox" id="dw-1" name="dias_semana" value="1">
            <label class="weekday-pill" for="dw-1" title="Martes">Mar</label>
          </div>
          <div class="weekday-toggle">
            <input class="weekday-input" type="checkbox" id="dw-2" name="dias_semana" value="2">
            <label class="weekday-pill" for="dw-2" title="Mi√©rcoles">Mi√©</label>
          </div>
          <div class="weekday-toggle">
            <input class="weekday-input" type="checkbox" id="dw-3" name="dias_semana" value="3">
            <label class="weekday-pill" for="dw-3" title="Jueves">Jue</label>
          </div>
          <div class="weekday-toggle">
            <input class="weekday-input" type="checkbox" id="dw-4" name="dias_semana" value="4">
            <label class="weekday-pill" for="dw-4" title="Viernes">Vie</label>
          </div>
          <div class="weekday-toggle">
            <input class="weekday-input" type="checkbox" id="dw-5" name="dias_semana" value="5">
            <label class="weekday-pill" for="dw-5" title="S√°bado">S√°b</label>
          </div>
          <div class="weekday-toggle">
            <input class="weekday-input" type="checkbox" id="dw-6" name="dias_semana" value="6">
            <label class="weekday-pill" for="dw-6" title="Domingo">Dom</label>
          </div>
        </div>
      </div>

      <div class="filters-bar" role="region" aria-label="Filtros de trabajadores">
        <label for="searchTrab" class="visually-hidden">Buscar trabajador</label>
        <input type="search" id="searchTrab" placeholder="Buscar por nombre‚Ä¶" aria-label="Buscar por nombre" />
        <label for="filtroPuesto">Puesto:</label>
        <select id="filtroPuesto" aria-label="Filtrar por puesto">
          <option value="">Todos</option>
          <option value="TS">TS</option>
          <option value="ADM">ADM</option>
          <option value="Administrador/a">Administrador/a</option>
        </select>
        <div class="selection-actions">
          <label for="applySelectedState">Aplicar a selecci√≥n:</label>
          <select id="applySelectedState" aria-label="Asignar estado a la selecci√≥n">
            <option value="">‚Äî Elige estado ‚Äî</option>
            <option value="-">-</option>
            <option value="normal">PIAS</option>
            <option value="CADE 30">CADE 30</option>
            <option value="CADE 50">CADE 50</option>
            <option value="CADE Tardes">CADE Tardes</option>
            <option value="Guardia CADE">Guardia CADE</option>
            <option value="Refuerzo Cade">Refuerzo Cade</option>
            <option value="Mail">Mail</option>
            <option value="Baja">Baja M√©dica</option>
          </select>
          <button type="button" id="applySelectedBtn">Aplicar</button>
        </div>
      </div>

      <div class="columns" id="columnsContainer">
        {% set orden = ['TS','ADM','Administrador/a'] %}
        {% for puesto in orden %}
        <div class="column-box" data-col-puesto="{{ puesto }}">
          <div class="column-header">
            <div class="column-title">{{ puesto }}</div>
          </div>
          <div class="rows">
            {% for trabajador in trabajadores %}
            {% if trabajador.puesto == puesto %}
            <div class="row" data-nombre="{{ trabajador.search_value }}" data-puesto="{{ trabajador.puesto }}">
              <input type="checkbox" class="select-row"
                aria-label="Seleccionar {{ hide_real_names and trabajador.display_name or trabajador.full_name }}" />
              <span class="name">{{ hide_real_names and trabajador.display_name or trabajador.full_name }}</span>
              <select name="tipo_{{ trabajador._id }}" id="tipo_{{ trabajador._id }}">
                <option value="">‚Äî</option>
                <option value="normal">PIAS</option>
                <option value="CADE 30">CADE 30</option>
                <option value="CADE 50">CADE 50</option>
                <option value="CADE Tardes">CADE Tardes</option>
                <option value="Guardia CADE">Guardia CADE</option>
                <option value="Refuerzo Cade">Refuerzo Cade</option>
                <option value="Mail">Mail</option>
                <option value="Baja">Baja M√©dica</option>
              </select>
            </div>
            {% endif %}
            {% endfor %}
          </div>
        </div>
        {% endfor %}
      </div>

      <button type="submit" class="btn">‚úÖ Asignar Estados</button>
      <button type="button" class="btn" onclick="window.location.href='/admin/duplicados'">üóÇÔ∏è Ver Estados
        Duplicados</button>
      <button type="button" class="btn" onclick="window.location.href='/calendar'">üîô Atr√°s</button>
    </form>
  </div>

  <!-- FullCalendar JS -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/fullcalendar/6.1.4/index.global.min.js"
    crossorigin="anonymous"></script>
  <script src="{{ url_for('static', filename='js/range-calendar.js') }}"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      // Accesibilidad: anunciar rango seleccionado
      const rangeInfoEl = document.getElementById('dateRangeInfo');
      rangeInfoEl.setAttribute('aria-live', 'polite');
      rangeInfoEl.setAttribute('role', 'status');
      initializeDateRangeCalendar({
        calendarId: 'dateRangeCalendar',
        startInputId: 'fecha_inicio',
        endInputId: 'fecha_fin',
        infoContainerId: 'dateRangeInfo',
        infoTextId: 'rangeText',
        submitSelector: 'button[type="submit"]'
      });

      document.querySelector('form').addEventListener('submit', function (e) {
        const fi = document.getElementById('fecha_inicio').value;
        const ff = document.getElementById('fecha_fin').value;
        if (!fi || !ff) {
          e.preventDefault();
          alert('Por favor, selecciona un rango de fechas v√°lido.');
        }
      });

      // Filtro por nombre/puesto
      const search = document.getElementById('searchTrab');
      const filtro = document.getElementById('filtroPuesto');
      const rows = Array.from(document.querySelectorAll('#columnsContainer .row'));
      function applyFilters() {
        const q = (search.value || '').toLowerCase().trim();
        const p = (filtro.value || '').trim();
        rows.forEach(row => {
          const matchesName = row.dataset.nombre.includes(q);
          const matchesRole = !p || row.dataset.puesto === p;
          row.style.display = (matchesName && matchesRole) ? '' : 'none';
        });
      }
      search.addEventListener('input', applyFilters);
      filtro.addEventListener('change', applyFilters);

      // Aplicar a selecci√≥n
      const applySelectedState = document.getElementById('applySelectedState');
      const applySelectedBtn = document.getElementById('applySelectedBtn');
      applySelectedBtn.addEventListener('click', () => {
        const val = applySelectedState.value;
        if (!val) {
          alert('Elige un estado para aplicar.');
          return;
        }
        const selectedRows = document.querySelectorAll('#columnsContainer .row .select-row:checked');
        let count = 0;
        selectedRows.forEach(cb => {
          const row = cb.closest('.row');
          const sel = row.querySelector('select');
          if (sel) { sel.value = (val === '-') ? '' : val; count++; }
        });
        if (!count) alert('No hay trabajadores seleccionados.');
      });
    });
  </script>
</body>

</html>